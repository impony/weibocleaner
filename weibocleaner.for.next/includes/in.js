var G_TPL = [
		".gn_logo_v2, .title_area, .tips_wrapper, #pl_leftnav_app, #pl_rightmod_yunying, #pl_relation_recommendGroupMember, #trustPagelet_recom_interestv5, #trustPagelet_zt_hottopicv5, #pl_rightmod_ads35, #pl_rightmod_ads36, #trustPagelet_recom_memberv5, #trustPagelet_recom_allinonev5, #pl_rightmod_noticeboard, .W_tips, .B_mention_me .W_main_r, .B_box_comment_at .W_main_r, .B_box_comment .W_main_r, .B_box_comment_c .W_main_r, .B_message_list .W_main_r, .B_favor_me .W_main_r, .B_send_me .W_main_r, #pl_relation_closefriendPr, #pl_relation_homeclosefriend, #pl_relation_recommendCloseFriendv5, #pl_rightmod_miyoupr, #pl_rightmod_groups, .global_footer, .spread_adv, .footer_adv, div[feedtype='ad'], .B_message_box_index .W_main_r, .B_box_msg .W_main_r, .WB_feed .popular_buss, .B_message_box .W_main_r, #trustPagelet_indexright_recom, .profile_pic_top, #pl_rightmod_friends, #pl_rightmod_recomFriends { display: none; }",

		"body { background-image: none; background-color: #353432; }",
		".W_miniblog, .W_miniblog_fb { background-image: none !important; background-color: transparent !important; }",
		".W_main, .gn_header { box-shadow: 0 0 10px #000; }",
		"	.gn_nav { margin-left: 0 !important; }",
		".W_miniblog { padding-top: 40px; min-width: 760px; }",
		".W_main_a { width: 830px; }",
		".W_main_c { width: 830px; background: #FFF; }",
		"	.B_index .W_main_c, .B_closefriend .W_main_c { padding-top: 5px; }",
		"	.group_read .group_read_layer_advance { width: 758px; }",
		".send_weibo { width: 670px; }",
		"	.gn_topmenulist_send .send_weibo { width: 415px; }",
		"	.send_weibo .input .input_detail { width: 658px; }",
		".W_main_r { margin-left: -230px; width: 140px; }",
		"a.W_gotop { margin-left: 495px; }",
		".gn_tips { left: 559px; }",

		"#pl_profile_cover { display: none; }",
		".layer_menulist_tags { width: 458px; }",
		".profile_tabbig { width: auto !important; }",
		".profile_top { min-height: 250px; }",
		"	.profile_top .pf_head { top: 15px; }",
		".B_profile .W_main_c, .B_profile_fans .W_main_c, .B_profile_info .W_main_c, .B_onefeed .W_main_c, .B_profile_pic .W_main_c, .P_weibo_album .wrapper { float: none; padding-bottom: 0; width: 980px !important; }",
		".B_profile .W_main_2r, .B_profile_fans .W_main_2r, .B_profile_info .W_main_2r, .B_onefeed .W_main_2r, .B_profile_pic .W_main_2r { float: none; margin-left: 20px; margin-bottom: 20px; width: 960px !important; }",
		"	#trustPagelet_profile_openApplist { display: none; }",
		"	.pul_list_big, .prm_app_pic { width: auto; }",
		".B_profile .WB_feed .repeat .input textarea, .B_onefeed .WB_feed .feed_repeat .input textarea { width: 888px; }",
		".B_profile .comment_list .repeat .input textarea, .B_onefeed .WB_feed .feed_repeat .repeat .input textarea { width: 806px; }",
		".B_index .WB_feed .repeat .input textarea, .big_comment_list .msg_box .feed_repeat .input textarea, .WB_feed .repeat .input textarea, .B_closefriend .WB_feed .repeat .input textarea { width: 678px; }",
		".B_index .comment_list .repeat .input textarea, .B_mention_me .comment_list .repeat .input textarea, .B_send_me .comment_list .repeat .input textarea, .B_closefriend .comment_list .repeat .input textarea { width: 591px; }",
		".WB_feed .list_pic_list, .WB_feed .list_pic_list .pic_list { width: auto; }",
		".WB_feed .WB_screen { margin-left: 778px; }",
		".B_profile .WB_feed .WB_screen { margin-left: 928px; }",
		".prm_app_pic .piclist { width: auto !important; }",
		"#pl_profile_accountOut iframe, .P_album_info .album_info { width: 940px !important; }",

		"#ifr_photo, .P_weibo_album .wrapper { margin-left: 10px; width: 950px !important }",
		".P_weibo_album { background-color: transparent; }",

		".profile_top .pf_verified, .profile_top .pf_verified_info, .profile_top .pf_star_info, .profile_top .pf_lady_info { text-align: left; }",
		".W_layer .profile_follow { width: 673px; }",
		".photolist img { width: 102px; height: 102px; }",

		".B_fans_myconn .W_main_c, .B_n_close_friend .W_main_c, .B_fans_watch .W_main_c, .B_n_invite36 .W_main_c { width: 555px; }",
		".B_fans_myconn .W_main_r, .B_n_close_friend .W_main_r, .B_fans_watch .W_main_r, .B_n_invite36 .W_main_r, .B_invite .W_main_r { display: none; }",
		".B_fans_myconn .W_main, .B_n_close_friend .W_main, .B_fans_watch .W_main, .B_n_invite36 .W_main, .B_invite .W_main, .B_find_fast .W_main { padding-top: 0; }",
		".B_fans_myconn .W_miniblog, .B_n_close_friend .W_miniblog, .B_fans_watch .W_miniblog, .B_n_invite36 .W_miniblog, .B_invite .W_miniblog, .B_find_fast .W_miniblog { background: none; }",
		".B_fans_myconn .W_main_bg, .B_n_close_friend .W_main_bg, .B_fans_watch .W_main_bg, .B_n_invite36 .W_main_bg, .B_invite .W_main_bg { background: #EEF8FB; }",
		".B_find_fast .W_main_bg { background: #FFF; }",
		".B_find_fast .W_main_215_r { display: none; }",

		".B_notice .W_main_r, .B_message_dialogue .W_main_r { display: none; }",
		".B_notice .W_main { padding-top: 0; }",

		".big_comment_list .msg_box .comment { width: 725px; }",
		".send_private_msgno .senc_input_box textarea { width: 780px; }",
		".send_private_msg .content { width: 790px; }",
		".private_dialogue .content { width: 618px; }",
		".user_atten_l { margin-top: 5px; margin-right: 0; }",
		"	.user_atten_l li strong { font-size: 12px; }"
	].join("");

var G_TPL_NARROW = [
		".W_main, .gn_header { width: 750px !important; }",
		"	.WB_global_nav .gn_title .gn_tab i { padding-left: 9px; padding-right: 15px; }",
		"	.WB_global_nav .gn_setting .gn_tab { padding-left: 5px; padding-right: 9px; width: 16px; }",
		".W_main_a { width: 600px; }",
		"	.B_myfans .W_main_a, .B_myfollow .W_main_a, .B_myfollow .mylistBox { width: 560px; }",
		".W_main_c { width: 600px; }",
		".send_weibo { width: 440px; }",
		"	.send_weibo .input .input_detail { width: 428px; }",
		"	.send_weibo .kind_v2 { width: 270px; }",
		"	.send_weibo .kind_v2 a>i { display: none; }",
		"a.W_gotop { margin-left: 380px; }",

		"	.profile_top .pf_info_right { float: none; width: 500px; margin-left: 0; padding-right: 0; }",
		"	.profile_top .pf_badge { float: none; display: block; }",
		"	.profile_top .badge_list { padding-left: 0; }",
		"		.profile_top .badge_list li { margin-left: 0; margin-right: 5px; }",
		".B_profile .W_main_c, .B_profile_fans .W_main_c, .B_profile_info .W_main_c, .B_onefeed .W_main_c, .B_profile_pic .W_main_c, .P_weibo_album .wrapper { width: 750px !important; }",
		".B_profile .W_main_2r, .B_profile_fans .W_main_2r, .B_profile_info .W_main_2r, .B_onefeed .W_main_2r, .B_profile_pic .W_main_2r { width: 730px !important; }",
		".B_profile .WB_feed .repeat .input textarea, .B_onefeed .WB_feed .feed_repeat .input textarea { width: 658px; }",
		".B_profile .comment_list .repeat .input textarea, .B_onefeed .WB_feed .feed_repeat .repeat .input textarea { width: 576px; }",
		".B_index .WB_feed .repeat .input textarea, .big_comment_list .msg_box .feed_repeat .input textarea, .WB_feed .repeat .input textarea, .B_closefriend .WB_feed .repeat .input textarea { width: 448px; }",
		".B_index .comment_list .repeat .input textarea, .B_mention_me .comment_list .repeat .input textarea, .B_send_me .comment_list .repeat .input textarea, .B_closefriend .comment_list .repeat .input textarea { width: 361px; }",
		".WB_feed .list_pic_list, .WB_feed .list_pic_list .pic_list { width: auto; }",
		".WB_feed .WB_screen { margin-left: 548px; }",
		".B_profile .WB_feed .WB_screen { margin-left: 698px; }",
		".big_comment_list .msg_box .comment { width: 495px; }",

		".PRF_tab_noicon { width: 750px; }",
		"	.PRF_tab_noicon .pftb_lk { width: 95px; }",

		"#pl_profile_accountOut iframe, .P_album_info .album_info { width: 710px !important; }",

		"#ifr_photo, .P_weibo_album .wrapper { width: 720px !important }",

		".send_weibo .kind_detail a { margin-right: 3px; }",

		".fixed_bar { width: 558px; }",
		"	.fixed_bar .bar_left>a { margin-right: 5px !important; }",
		"		.fixed_bar .bar_left>a>span { padding: 0 2px !important; }",
		"		.fixed_bar .bar_left .W_btn_c:nth-child(1) { width: 28px; }",
		"		.fixed_bar .bar_left .W_btn_c:nth-child(2) { width: 76px; }",
		".B_myfollow .mylistBox .myfollow_list { width: 247px; }",
		"	.B_myfollow .mylistBox .myfollow_list:nth-child(2n) { margin-right: 0; }",
		".B_myfollow .page_fixed_bar { width: 560px; }"
	].join("");

var G_PAGESWITCH;
var G_PAGECOLOR;
var G_PAGEWIDTH;
var G_G = {
	"styleid": "imponystyle",
	"styleid_narrow": "imponystyle_narrow"
};

function $_$(id) {
	return document.getElementById(id);
}

function reRender(str, id) {
	var head = document.head;
	if($_$(G_G.styleid) && $_$(G_G.styleid_narrow)) {
		return;
	}
	var style = document.createElement("style");
	style.innerHTML = str;
	style.id = id;
	head.appendChild(style);
}

function formatSkin(skinid) {
	var links = document.querySelectorAll("link");
	var custom_style;
	for(var i = links.length; i--;) {
		if(links[i].href.match(/skin\d+/gi)) {
			links[i].href = links[i].href.replace(/skin\d+/gi, "diy/" + skinid);
			break;
		}
	}
	if(document.getElementById("custom_style")) {
		custom_style = document.getElementById("custom_style");
		custom_style.innerHTML = custom_style.innerHTML.match(/@import.+/gi)[0].replace(/diy\d+/gi, skinid);
	}
}

chrome.storage.local.get("weibocleaner_pageswitch", function (fetchedData) {
	G_PAGESWITCH = fetchedData.weibocleaner_pageswitch ? fetchedData.weibocleaner_pageswitch : "on";
	if(G_PAGESWITCH === "on") {
		reRender(G_TPL, G_G.styleid);

		chrome.storage.local.get("weibocleaner_pagecolor", function (fetchedData) {
			G_PAGECOLOR = fetchedData.weibocleaner_pagecolor ? fetchedData.weibocleaner_pagecolor : "diy003";
			formatSkin(G_PAGECOLOR);
		});

		chrome.storage.local.get("weibocleaner_pagewidth", function (fetchedData) {
			G_PAGEWIDTH = fetchedData.weibocleaner_pagewidth ? fetchedData.weibocleaner_pagewidth : "wide";
			if(G_PAGEWIDTH === "narrow") {
				reRender(G_TPL_NARROW, G_G.styleid_narrow);
			}
		});

		if(window.location.host.indexOf("photo.weibo.com") != -1) {
			document.body.style.backgroundColor = "#FFF";
		}
	}
});